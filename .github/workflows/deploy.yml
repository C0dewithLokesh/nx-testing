name: deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      mode:
        description: 'Choose deployment mode'
        required: true
        default: 'affected'
        type: choice
        options:
          - affected
          - all

permissions:
  actions: read
  contents: read

jobs:
  main:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9.8.0
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - uses: nrwl/nx-set-shas@v4

      # âœ… Get affected or all services (no temp files)
      - name: Get list of services based on mode
        id: get-services
        run: |
          if [ "${{ github.event.inputs.mode }}" = "all" ]; then
            echo "ğŸ“¦ Mode: ALL â€” listing services in apps/*"
            services=$(pnpm exec nx show projects --projects "apps/*")
          else
            echo "ğŸ” Mode: AFFECTED â€” listing affected services"
            services=$(pnpm exec nx show projects --affected)
          fi

          echo "$services"

          # Convert to CSV for later use
          services_csv=$(echo "$services" | paste -sd "," -)
          echo "services=$services_csv" >> "$GITHUB_OUTPUT"

      # ğŸ§ª Lint, test, build (only for affected)
      - name: Run tasks (lint, test, build)
        run: pnpm exec nx affected -t lint test build

      # ğŸ–¨ï¸ Log the list of services
      - name: Log selected services
        run: |
          echo "ğŸ“ Selected Services: ${{ steps.get-services.outputs.services }}"
