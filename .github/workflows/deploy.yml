name: deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      mode:
        description: 'Choose deployment mode'
        required: true
        default: 'affected'
        type: choice
        options:
          - affected
          - all

permissions:
  actions: read
  contents: read

jobs:
  main:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9.8.0
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - uses: nrwl/nx-set-shas@v4

      # ğŸ” Determine list of services based on input mode
      - name: Get list of services based on mode
        id: get-services
        run: |
          if [ "${{ github.event.inputs.mode }}" = "all" ]; then
            echo "ğŸ“¦ Mode: ALL â€” listing all services"
            pnpm exec nx show projects --type=app > services.txt
          else
            echo "ğŸ” Mode: AFFECTED â€” listing affected services"
            pnpm exec nx show projects --affected --type=app > services.txt
          fi

          cat services.txt

          # Convert to comma-separated list for later use
          services=$(paste -sd "," services.txt)
          echo "services=$services" >> "$GITHUB_OUTPUT"

      # ğŸ§ª Run lint, test, build for affected targets (you can replace this with per-service logic)
      - name: Run tasks (lint, test, build)
        run: pnpm exec nx affected -t lint test build

      # ğŸ–¨ï¸ Log the selected services clearly
      - name: Log selected services
        run: |
          echo "ğŸ“ Selected Services: ${{ steps.get-services.outputs.services }}"
