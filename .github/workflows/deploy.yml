name: deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deployment_scope:
        description: 'Select what to deploy'
        required: true
        default: 'affected'
        type: choice
        options:
          - affected
          - all
      service_name:
        description: 'Optional: Deploy specific service (overrides scope)'
        required: false
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      branch_name:
        description: 'Branch to deploy (only for dev)'
        required: false

permissions:
  actions: read
  contents: read

jobs:
  main:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 9.8.0
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - uses: nrwl/nx-set-shas@v4

      - name: Log deployment configuration
        run: |
          echo "ğŸš€ Deployment Configuration:"
          echo "ğŸ”¹ Environment       : ${{ github.event.inputs.environment }}"
          echo "ğŸ”¹ Deployment Scope  : ${{ github.event.inputs.deployment_scope }}"
          echo "ğŸ”¹ Service Name      : ${{ github.event.inputs.service_name }}"
          echo "ğŸ”¹ Branch Name       : ${{ github.event.inputs.branch_name }}"

      # âœ… Get affected or all services (no temp files)
      - name: Get list of services based on mode
        id: get-services
        run: |
          if [ "${{ github.event.inputs.deployment_scope }}" = "all" ]; then
            echo "ğŸ“¦ Mode: ALL â€” listing services in apps/*"
            services=$(pnpm exec nx show projects --projects "apps/*")
          else
            echo "ğŸ” Mode: AFFECTED â€” listing affected services"
            services=$(pnpm exec nx show projects --affected)
          fi

          echo "$services"

          # Convert to CSV for later use
          services_csv=$(echo "$services" | paste -sd "," -)
          echo "services=$services_csv" >> "$GITHUB_OUTPUT"

      # ğŸ§ª Lint, test, build (only for affected)
      - name: Run tasks (lint, test, build)
        run: |
          if [ "${{ github.event.inputs.deployment_scope }}" = "all" ]; then
            echo "ğŸ“¦ Mode: ALL â€” listing services in apps/*"
            pnpm exec nx run-many -t lint test build --all
          else
            echo "ğŸ” Mode: AFFECTED â€” listing affected services"
            pnpm exec nx affected -t lint test build
          fi

      # ğŸ–¨ï¸ Log the list of services
      - name: Log selected services
        run: |
          echo "ğŸ“ Selected Services: ${{ steps.get-services.outputs.services }}"
